<?php
require_once 'config.php';

// Check if user is admin or librarian
if (!isAdminOrLibrarian()) {
    header('HTTP/1.0 403 Forbidden');
    echo "Access denied. This area is only accessible by administrators and librarians.";
    exit();
}

// Get current user info from database
$user_id = $_SESSION['user_id'];
$stmt = $pdo->prepare("
    SELECT u.*, ur.role_name 
    FROM users u 
    JOIN user_roles ur ON u.role_id = ur.id 
    WHERE u.id = ?
");
$stmt->execute([$user_id]);
$current_user = $stmt->fetch(PDO::FETCH_ASSOC);

// Get current page for active link highlighting
$current_page = basename($_SERVER['PHP_SELF']);
?>

<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sabian Library - Dashboard</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Material+Symbols+Rounded:opsz,wght,FILL,GRAD@24,400,0,0" />
    <style>
        /* Your existing CSS remains the same, just adding one new rule */
        .sidebar.collapsed .sidebar-toggler {
            display: none;
        }
        
        @media (max-width: 1023px) {
            .sidebar-toggler {
                display: none !important;
            }
        }
    </style>
</head>
<body>
    <!-- Header -->
    <header class="header">
        <div class="header-container">
            <div class="header-content">
                <div class="brand">
                    <i class="fas fa-book-open brand-icon"></i>
                    <span class="brand-text">Sabian</span>
                </div>

                <div class="header-actions">
                    <button class="theme-toggle" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                    <button class="sidebar-toggle" id="sidebarToggle">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </div>
    </header>

    <!-- Sidebar Overlay -->
    <div class="sidebar-overlay" id="sidebarOverlay"></div>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <!-- Sidebar Header -->
        <div class="sidebar-header">
            <div class="sidebar-brand">
                <i class="fas fa-book-open brand-icon"></i>
                <span class="brand-text">Sabian</span>
            </div>
            <button class="sidebar-toggler" id="sidebarToggler">
                <span class="material-symbols-rounded">chevron_left</span>
            </button>
        </div>
        
        <div class="sidebar-date" id="currentDate">
            <!-- Date will be populated by JavaScript -->
        </div>
        
        <!-- User Info -->
        <div class="sidebar-user">
            <div class="user-avatar-sidebar">
                <?php if (!empty($current_user['profile_pic'])): ?>
                    <img src="<?php echo htmlspecialchars($current_user['profile_pic']); ?>" alt="Profile">
                <?php else: ?>
                    <img src="https://ui-avatars.com/api/?name=<?php echo urlencode($current_user['first_name'] . '+' . $current_user['last_name']); ?>&background=0f2a1d&color=fff&size=120" alt="Profile">
                <?php endif; ?>
            </div>
            <div class="user-info-sidebar">
                <div class="user-name-sidebar"><?php echo htmlspecialchars($current_user['first_name'] . ' ' . $current_user['last_name']); ?></div>
                <div class="user-role-sidebar"><?php echo htmlspecialchars(ucfirst($current_user['role_name'])); ?></div>
            </div>
        </div>

        <!-- Search -->
        <div class="sidebar-search">
            <div class="search-container-sidebar">
                <i class="fas fa-search search-icon-sidebar"></i>
                <input type="text" class="search-input-sidebar" placeholder="Search books, members...">
            </div>
        </div>

        <!-- Navigation -->
        <nav class="sidebar-nav">
            <!-- Main Navigation -->
            <div class="nav-section">
                <div class="section-title">Main</div>
                <ul class="nav-links-sidebar">
                    <li class="nav-item-sidebar">
                        <a href="dashboard.php" class="nav-link-sidebar <?php echo $current_page === 'dashboard.php' ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">dashboard</span>
                            <span class="nav-text">Dashboard</span>
                        </a>
                    </li>
                    
                    <!-- Books Dropdown -->
                    <li class="nav-item-sidebar dropdown-container">
                        <a href="#" class="nav-link-sidebar dropdown-toggle <?php echo in_array($current_page, ['books.php', 'add_book.php', 'categories.php', 'popular_books.php']) ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">menu_book</span>
                            <span class="nav-text">Books</span>
                            <span class="dropdown-icon material-symbols-rounded">keyboard_arrow_down</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="nav-item-sidebar"><a class="nav-link-sidebar dropdown-title">Books</a></li>
                            <li class="nav-item-sidebar">
                                <a href="books.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'books.php' ? 'active' : ''; ?>">
                                    All Books
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="add_book.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'add_book.php' ? 'active' : ''; ?>">
                                    Add New Book
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="categories.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'categories.php' ? 'active' : ''; ?>">
                                    Book Categories
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="popular_books.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'popular_books.php' ? 'active' : ''; ?>">
                                    Popular Books
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <!-- Members Dropdown -->
                    <li class="nav-item-sidebar dropdown-container">
                        <a href="#" class="nav-link-sidebar dropdown-toggle <?php echo in_array($current_page, ['members.php', 'add_member.php', 'membership_types.php']) ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">groups</span>
                            <span class="nav-text">Members</span>
                            <span class="dropdown-icon material-symbols-rounded">keyboard_arrow_down</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="nav-item-sidebar"><a class="nav-link-sidebar dropdown-title">Members</a></li>
                            <li class="nav-item-sidebar">
                                <a href="members.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'members.php' ? 'active' : ''; ?>">
                                    All Members
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="add_member.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'add_member.php' ? 'active' : ''; ?>">
                                    Add New Member
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="membership_types.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'membership_types.php' ? 'active' : ''; ?>">
                                    Membership Types
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <li class="nav-item-sidebar">
                        <a href="reports.php" class="nav-link-sidebar <?php echo $current_page === 'reports.php' ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">analytics</span>
                            <span class="nav-text">Reports</span>
                        </a>
                    </li>
                </ul>
            </div>

            <!-- Management -->
            <div class="nav-section">
                <div class="section-title">Management</div>
                <ul class="nav-links-sidebar">
                    <!-- Borrowings Dropdown -->
                    <li class="nav-item-sidebar dropdown-container">
                        <a href="#" class="nav-link-sidebar dropdown-toggle <?php echo in_array($current_page, ['current_borrowings.php', 'borrow_history.php', 'overdue_books.php', 'return_books.php']) ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">swap_horiz</span>
                            <span class="nav-text">Borrowings</span>
                            <span class="dropdown-icon material-symbols-rounded">keyboard_arrow_down</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="nav-item-sidebar"><a class="nav-link-sidebar dropdown-title">Borrowings</a></li>
                            <li class="nav-item-sidebar">
                                <a href="current_borrowings.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'current_borrowings.php' ? 'active' : ''; ?>">
                                    Current Borrowings
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="borrow_history.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'borrow_history.php' ? 'active' : ''; ?>">
                                    Borrow History
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="overdue_books.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'overdue_books.php' ? 'active' : ''; ?>">
                                    Overdue Books
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="return_books.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'return_books.php' ? 'active' : ''; ?>">
                                    Return Books
                                </a>
                            </li>
                        </ul>
                    </li>
                    
                    <li class="nav-item-sidebar">
                        <a href="categories.php" class="nav-link-sidebar <?php echo $current_page === 'categories.php' ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">category</span>
                            <span class="nav-text">Categories</span>
                        </a>
                    </li>
                    
                    <!-- User Management Dropdown (Admin Only) -->
                    <?php if (isAdmin()): ?>
                    <li class="nav-item-sidebar dropdown-container">
                        <a href="#" class="nav-link-sidebar dropdown-toggle <?php echo in_array($current_page, ['users.php', 'roles.php', 'activity_log.php']) ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">admin_panel_settings</span>
                            <span class="nav-text">User Management</span>
                            <span class="dropdown-icon material-symbols-rounded">keyboard_arrow_down</span>
                        </a>
                        <ul class="dropdown-menu">
                            <li class="nav-item-sidebar"><a class="nav-link-sidebar dropdown-title">User Management</a></li>
                            <li class="nav-item-sidebar">
                                <a href="users.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'users.php' ? 'active' : ''; ?>">
                                    All Users
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="roles.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'roles.php' ? 'active' : ''; ?>">
                                    Roles & Permissions
                                </a>
                            </li>
                            <li class="nav-item-sidebar">
                                <a href="activity_log.php" class="nav-link-sidebar dropdown-link <?php echo $current_page === 'activity_log.php' ? 'active' : ''; ?>">
                                    Activity Log
                                </a>
                            </li>
                        </ul>
                    </li>
                    <?php endif; ?>
                </ul>
            </div>

            <!-- User Section -->
            <div class="nav-section">
                <div class="section-title">Account</div>
                <ul class="nav-links-sidebar">
                    <li class="nav-item-sidebar">
                        <a href="profile.php" class="nav-link-sidebar <?php echo $current_page === 'profile.php' ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">person</span>
                            <span class="nav-text">Profile</span>
                        </a>
                    </li>
                    <li class="nav-item-sidebar">
                        <a href="settings.php" class="nav-link-sidebar <?php echo $current_page === 'settings.php' ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">settings</span>
                            <span class="nav-text">Settings</span>
                        </a>
                    </li>
                    <li class="nav-item-sidebar">
                        <a href="help.php" class="nav-link-sidebar <?php echo $current_page === 'help.php' ? 'active' : ''; ?>">
                            <span class="material-symbols-rounded nav-icon">help</span>
                            <span class="nav-text">Help & Support</span>
                        </a>
                    </li>
                    <li class="nav-item-sidebar">
                        <a href="logout.php" class="nav-link-sidebar">
                            <span class="material-symbols-rounded nav-icon">logout</span>
                            <span class="nav-text">Logout</span>
                        </a>
                    </li>
                </ul>
            </div>
        </nav>

        <!-- Sidebar Footer -->
        <div class="sidebar-footer">
            <button class="theme-toggle-sidebar" id="sidebarThemeToggle">
                <i class="fas fa-moon"></i>
                <span class="theme-text">Dark Mode</span>
            </button>
        </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
        <div class="container">
            <h1 class="page-title">Dashboard Overview</h1>
            
            <div class="stats-grid">
                <!-- Your existing stats cards -->
                <div class="stat-card">
                    <div class="stat-header">
                        <div class="stat-title">Total Books</div>
                        <div class="stat-icon">
                            <i class="fas fa-book"></i>
                        </div>
                    </div>
                    <div class="stat-value">1,248</div>
                    <div class="stat-change positive">
                        <i class="fas fa-arrow-up"></i> 12% from last month
                    </div>
                </div>
                
                <!-- Other stat cards... -->
            </div>
            
            <div class="card">
                <div class="card-header">Welcome to Sabian Library</div>
                <p>Welcome back, <?php echo htmlspecialchars($current_user['first_name']); ?>! You are logged in as <?php echo htmlspecialchars(ucfirst($current_user['role_name'])); ?>.</p>
                <p>This dashboard is accessible only to administrators and librarians.</p>
            </div>
        </div>
    </main>

    <script>
        // Enhanced JavaScript with auto-open dropdowns for active pages
        document.addEventListener('DOMContentLoaded', function() {
            // Theme functionality (same as before)
            const themeToggle = document.getElementById('themeToggle');
            const sidebarThemeToggle = document.getElementById('sidebarThemeToggle');
            const sidebarToggler = document.getElementById('sidebarToggler');
            
            function initTheme() {
                const savedTheme = localStorage.getItem('theme') || 'light';
                document.body.setAttribute('data-theme', savedTheme);
                updateThemeElements(savedTheme);
            }
            
            function updateThemeElements(theme) {
                const isDark = theme === 'dark';
                const themeIcons = document.querySelectorAll('.theme-toggle i, .theme-toggle-sidebar i');
                themeIcons.forEach(icon => {
                    icon.className = isDark ? 'fas fa-sun' : 'fas fa-moon';
                });
                
                const themeTexts = document.querySelectorAll('.theme-text');
                themeTexts.forEach(text => {
                    text.textContent = isDark ? 'Light Mode' : 'Dark Mode';
                });
            }
            
            function toggleTheme() {
                const currentTheme = document.body.getAttribute('data-theme');
                const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
                document.body.setAttribute('data-theme', newTheme);
                localStorage.setItem('theme', newTheme);
                updateThemeElements(newTheme);
            }
            
            initTheme();
            themeToggle.addEventListener('click', toggleTheme);
            sidebarThemeToggle.addEventListener('click', toggleTheme);
            
            // Sidebar functionality
            const sidebar = document.getElementById('sidebar');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const sidebarToggle = document.getElementById('sidebarToggle');
            
            function toggleSidebar() {
                sidebar.classList.toggle('active');
                sidebarOverlay.classList.toggle('active');
                document.body.style.overflow = sidebar.classList.contains('active') ? 'hidden' : '';
            }
            
            function toggleSidebarCollapse() {
                sidebar.classList.toggle('collapsed');
                const icon = sidebarToggler.querySelector('span');
                icon.textContent = sidebar.classList.contains('collapsed') ? 'chevron_right' : 'chevron_left';
            }
            
            sidebarToggle.addEventListener('click', toggleSidebar);
            sidebarOverlay.addEventListener('click', toggleSidebar);
            sidebarToggler.addEventListener('click', toggleSidebarCollapse);
            
            // Close sidebar when clicking on nav links (mobile)
            const navLinks = document.querySelectorAll('.nav-link-sidebar:not(.dropdown-toggle)');
            navLinks.forEach(link => {
                link.addEventListener('click', function() {
                    if (window.innerWidth < 1024) {
                        toggleSidebar();
                    }
                });
            });
            
            // Enhanced Dropdown functionality
            const toggleDropdown = (dropdown, menu, isOpen) => {
                dropdown.classList.toggle("open", isOpen);
                if (isOpen) {
                    menu.style.height = `${menu.scrollHeight}px`;
                } else {
                    menu.style.height = '0';
                }
            };

            const closeAllDropdowns = () => {
                document.querySelectorAll(".dropdown-container.open").forEach((openDropdown) => {
                    toggleDropdown(openDropdown, openDropdown.querySelector(".dropdown-menu"), false);
                });
            };

            // Auto-open dropdown if it contains active link
            document.querySelectorAll('.dropdown-container').forEach(dropdown => {
                const activeLink = dropdown.querySelector('.dropdown-link.active');
                if (activeLink) {
                    const menu = dropdown.querySelector('.dropdown-menu');
                    toggleDropdown(dropdown, menu, true);
                }
            });

            document.querySelectorAll(".dropdown-toggle").forEach((dropdownToggle) => {
                dropdownToggle.addEventListener("click", (e) => {
                    e.preventDefault();
                    e.stopPropagation();

                    const dropdown = dropdownToggle.closest(".dropdown-container");
                    const menu = dropdown.querySelector(".dropdown-menu");
                    const isOpen = dropdown.classList.contains("open");

                    closeAllDropdowns();
                    toggleDropdown(dropdown, menu, !isOpen);
                });
            });

            document.addEventListener('click', function(e) {
                if (!e.target.closest('.dropdown-container') && window.innerWidth >= 1024) {
                    closeAllDropdowns();
                }
            });
            
            // Update date
            function updateDate() {
                const dateElement = document.getElementById('currentDate');
                if (dateElement) {
                    const now = new Date();
                    const options = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
                    dateElement.textContent = now.toLocaleDateString('en-US', options);
                }
            }
            
            updateDate();
            
            // Handle window resize - hide collapse button on mobile
            function handleResize() {
                if (window.innerWidth >= 1024) {
                    sidebar.classList.remove('active');
                    sidebarOverlay.classList.remove('active');
                    document.body.style.overflow = '';
                    // Show collapse button on desktop
                    sidebarToggler.style.display = 'flex';
                } else {
                    // Hide collapse button on mobile
                    sidebarToggler.style.display = 'none';
                    // On mobile, ensure sidebar is expanded by default when opened
                    if (sidebar.classList.contains('active')) {
                        sidebar.classList.remove('collapsed');
                    }
                }
            }
            
            window.addEventListener('resize', handleResize);
            handleResize(); // Initial check
            
            // Initialize sidebar based on screen size
            if (window.innerWidth >= 1024) {
                sidebar.classList.add('active');
            }
        });
    </script>
</body>
</html>
